name: "Deploy to NPM Registry"
description: "Download artifacts and deploy package to NPM registry using yarn npm publish"

inputs:
  artifact-name:
    description: "Name of the artifact to download"
    required: false
  node-version:
    description: "Node.js version to use"
    required: false
  access:
    description: "Access level for the package (e.g., public, restricted)"
    required: false
    default: "public"

runs:
  using: "composite"
  steps:
    - name: Setup Node.js Environment
      uses: SKILL-FAMILIAR-PJ/devops-template/actions/common/setup/node@main
      if: ${{ inputs.node-version != '' }}
      with:
        node-version: 20
        install-command: yarn install --immutable

    - name: Download build artifacts
      uses: actions/download-artifact@v5
      if: ${{ inputs.artifact-name != '' }}
      with:
        name: ${{ inputs.artifact-name }}

    - name: Sync package version with tag
      if: startsWith(github.ref, 'refs/tags/')
      shell: bash
      run: |
        TAG_NAME="${GITHUB_REF#refs/tags/}"
        VERSION="$TAG_NAME"
        if [[ "$VERSION" == v* ]]; then
          VERSION="${VERSION:1}"
        fi

        echo "Setting package.json version to $VERSION"
        tmp_file="$(mktemp)"
        jq --arg version "$VERSION" '.version = $version' package.json > "$tmp_file"
        mv "$tmp_file" package.json

    - name: Publish to registry
      shell: bash
      run: |
        # Extract tag from GitHub ref
        TAG_NAME=${GITHUB_REF#refs/tags/}

        # Determine npm tag based on GitHub tag
        if [[ $TAG_NAME =~ -([A-Z]+)\. ]]; then
          NPM_TAG=$(echo "${BASH_REMATCH[1]}" | tr '[:upper:]' '[:lower:]')
          echo "Extracted environment tag: $NPM_TAG"
        else
          NPM_TAG="latest"
          echo "No environment suffix found, using: $NPM_TAG"
        fi

        echo "Publishing with tag: $NPM_TAG"
        yarn npm publish --tag $NPM_TAG --access ${{ inputs.access }}
